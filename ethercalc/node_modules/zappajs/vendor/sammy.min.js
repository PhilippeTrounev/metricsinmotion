!function(e,t){!function(n){"function"==typeof define&&define.amd?define(["jquery"],n):e.sammy=t.Sammy=n(e)}(function(e){var n,r="([^/]+)",i=/:([\w\d]+)/g,o=/\?([^#]*)?$/,a=function(e){return Array.prototype.slice.call(e)},s=function(e){return"[object Function]"===Object.prototype.toString.call(e)},u=function(e){return"[object Array]"===Object.prototype.toString.call(e)},l=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},c=function(e){return decodeURIComponent((e||"").replace(/\+/g," "))},p=encodeURIComponent,f=function(e){return String(e).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},d=function(e){return function(){return this.route.apply(this,[e].concat(Array.prototype.slice.call(arguments)))}},h={},g=!(!t.history||!history.pushState),m=[];return n=function(){var t,r,i=a(arguments);return n.apps=n.apps||{},0===i.length||i[0]&&s(i[0])?n.apply(n,["body"].concat(i)):"string"==typeof(r=i.shift())?(t=n.apps[r]||new n.Application,t.element_selector=r,i.length>0&&e.each(i,function(e,n){t.use(n)}),t.element_selector!=r&&delete n.apps[r],n.apps[t.element_selector]=t,t):void 0},n.VERSION="0.7.4",n.addLogger=function(e){m.push(e)},n.log=function(){var t=a(arguments);t.unshift("["+Date()+"]"),e.each(m,function(e,r){r.apply(n,t)})},"undefined"!=typeof t.console?s(t.console.log.apply)?n.addLogger(function(){t.console.log.apply(t.console,arguments)}):n.addLogger(function(){t.console.log(arguments)}):"undefined"!=typeof console&&n.addLogger(function(){console.log.apply(console,arguments)}),e.extend(n,{makeArray:a,isFunction:s,isArray:u}),n.Object=function(t){return e.extend(this,t||{})},e.extend(n.Object.prototype,{escapeHTML:f,h:f,toHash:function(){var t={};return e.each(this,function(e,n){s(n)||(t[e]=n)}),t},toHTML:function(){var t="";return e.each(this,function(e,n){s(n)||(t+="<strong>"+e+"</strong> "+n+"<br />")}),t},keys:function(e){var t=[];for(var n in this)s(this[n])&&e||t.push(n);return t},has:function(t){return this[t]&&""!==e.trim(this[t].toString())},join:function(){var e=a(arguments),t=e.shift();return e.join(t)},log:function(){n.log.apply(n,arguments)},toString:function(t){var n=[];return e.each(this,function(e,r){(!s(r)||t)&&n.push('"'+e+'": '+r.toString())}),"Sammy.Object: {"+n.join(",")+"}"}}),n.targetIsThisWindow=function(n){var r=e(n.target).attr("target");return r&&r!==t.name&&"_self"!==r?"_blank"===r?!1:"top"===r&&t===t.top?!0:!1:!0},n.DefaultLocationProxy=function(e,t){this.app=e,this.is_native=!1,this.has_history=g,this._startPolling(t)},n.DefaultLocationProxy.fullPath=function(e){var t=e.toString().match(/^[^#]*(#.+)$/),n=t?t[1]:"";return[e.pathname,e.search,n].join("")},e.extend(n.DefaultLocationProxy.prototype,{bind:function(){var r=this,i=this.app,o=n.DefaultLocationProxy;e(t).bind("hashchange."+this.app.eventNamespace(),function(e,n){r.is_native!==!1||n||(r.is_native=!0,t.clearInterval(o._interval),o._interval=null),i.trigger("location-changed")}),g&&!i.disable_push_state&&(e(t).bind("popstate."+this.app.eventNamespace(),function(){i.trigger("location-changed")}),e(document).delegate("a","click.history-"+this.app.eventNamespace(),function(e){if(!(e.isDefaultPrevented()||e.metaKey||e.ctrlKey)){var a=o.fullPath(this);return this.hostname==t.location.hostname&&i.lookupRoute("get",a)&&n.targetIsThisWindow(e)?(e.preventDefault(),r.setLocation(a),!1):void 0}})),o._bindings||(o._bindings=0),o._bindings++},unbind:function(){e(t).unbind("hashchange."+this.app.eventNamespace()),e(t).unbind("popstate."+this.app.eventNamespace()),e(document).undelegate("a","click.history-"+this.app.eventNamespace()),n.DefaultLocationProxy._bindings--,n.DefaultLocationProxy._bindings<=0&&(t.clearInterval(n.DefaultLocationProxy._interval),n.DefaultLocationProxy._interval=null)},getLocation:function(){return n.DefaultLocationProxy.fullPath(t.location)},setLocation:function(e){if(/^([^#\/]|$)/.test(e)&&(e=g&&!this.app.disable_push_state?"/"+e:"#!/"+e),e!=this.getLocation()){if(!g||this.app.disable_push_state||!/^\//.test(e))return t.location=e;history.pushState({path:e},t.title,e),this.app.trigger("location-changed")}},_startPolling:function(r){var i=this;if(!n.DefaultLocationProxy._interval){r||(r=10);var o=function(){var r=i.getLocation();("undefined"==typeof n.DefaultLocationProxy._last_location||r!=n.DefaultLocationProxy._last_location)&&t.setTimeout(function(){e(t).trigger("hashchange",[!0])},0),n.DefaultLocationProxy._last_location=r};o(),n.DefaultLocationProxy._interval=t.setInterval(o,r)}}}),n.Application=function(e){var t=this;this.routes={},this.listeners=new n.Object({}),this.arounds=[],this.befores=[],this.namespace=(new Date).getTime()+"-"+parseInt(1e3*Math.random(),10),this.context_prototype=function(){n.EventContext.apply(this,arguments)},this.context_prototype.prototype=new n.EventContext,s(e)&&e.apply(this,[this]),this._location_proxy||this.setLocationProxy(new n.DefaultLocationProxy(this,this.run_interval_every)),this.debug&&this.bindToAllEvents(function(e,n){t.log(t.toString(),e.cleaned_type,n||{})})},n.Application.prototype=e.extend({},n.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(t){return t?e(this.element_selector).find(t):e(this.element_selector)},use:function(){var e=a(arguments),t=e.shift(),r=t||"";try{e.unshift(this),"string"==typeof t&&(r="Sammy."+t,t=n[t]),t.apply(this,e)}catch(i){"undefined"==typeof t?this.error("Plugin Error: called use() but plugin ("+r.toString()+") is not defined",i):s(t)?this.error("Plugin Error",i):this.error("Plugin Error: called use() but '"+r.toString()+"' is not a function",i)}return this},setLocationProxy:function(e){var t=this._location_proxy;this._location_proxy=e,this.isRunning()&&(t&&t.unbind(),this._location_proxy.bind())},log:function(){n.log.apply(n,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(t,n){var o,a,u=this,l=[],c=Array.prototype.slice.call(arguments,2);if(0===c.length&&s(n)&&(n=t,c=[n],t="any"),t=t.toLowerCase(),n.constructor==String){for(i.lastIndex=0;null!==(a=i.exec(n));)l.push(a[1]);n=new RegExp(n.replace(i,r)+"$")}return e.each(c,function(e,t){"string"==typeof t&&(c[e]=u[t])}),o=function(e){var t={verb:e,path:n,callback:c,param_names:l};u.routes[e]=u.routes[e]||[],u.routes[e].push(t)},"any"===t?e.each(this.ROUTE_VERBS,function(e,t){o(t)}):o(t),this},get:d("get"),post:d("post"),put:d("put"),del:d("delete"),any:d("any"),mapRoutes:function(t){var n=this;return e.each(t,function(e,t){n.route.apply(n,t)}),this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(e,t,n){var r=this;"undefined"==typeof n&&(n=t);var i=function(){var e,t,i;e=arguments[0],i=arguments[1],i&&i.context?(t=i.context,delete i.context):t=new r.context_prototype(r,"bind",e.type,i,e.target),e.cleaned_type=e.type.replace(r.eventNamespace(),""),n.apply(t,[e,i])};return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(i),this.isRunning()&&this._listen(e,i),this},trigger:function(e,t){return this.$element().trigger([e,this.eventNamespace()].join("."),[t]),this},refresh:function(){return this.last_location=null,this.trigger("location-changed"),this},before:function(e,t){return s(e)&&(t=e,e={}),this.befores.push([e,t]),this},after:function(e){return this.bind("event-context-after",e)},around:function(e){return this.arounds.push(e),this},onComplete:function(e){return this._onComplete=e,this},isRunning:function(){return this._running},helpers:function(t){return e.extend(this.context_prototype.prototype,t),this},helper:function(e,t){return this.context_prototype.prototype[e]=t,this},run:function(r){if(this.isRunning())return!1;var i=this;return e.each(this.listeners.toHash(),function(t,n){e.each(n,function(e,n){i._listen(t,n)})}),this.trigger("run",{start_url:r}),this._running=!0,this.last_location=null,/\#(.+)/.test(this.getLocation())||"undefined"==typeof r||this.setLocation(r),this._checkLocation(),this._location_proxy.bind(),this.bind("location-changed",function(){i._checkLocation()}),this.bind("submit",function(t){if(!n.targetIsThisWindow(t))return!0;var r=i._checkFormSubmission(e(t.target).closest("form"));return r===!1?t.preventDefault():!1}),e(t).bind("unload",function(){i.unload()}),this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var t=this;return this.trigger("unload"),this._location_proxy.unbind(),this.$element().unbind("submit").removeClass(t.eventNamespace()),e.each(this.listeners.toHash(),function(n,r){e.each(r,function(e,r){t._unlisten(n,r)})}),this._running=!1,this},destroy:function(){return this.unload(),delete n.apps[this.element_selector],this},bindToAllEvents:function(t){var n=this;return e.each(this.APP_EVENTS,function(e,r){n.bind(r,t)}),e.each(this.listeners.keys(!0),function(r,i){-1==e.inArray(i,n.APP_EVENTS)&&n.bind(i,t)}),this},routablePath:function(e){return e.replace(o,"")},lookupRoute:function(e,t){var n,r,i=this,o=!1,a=0;if("undefined"!=typeof this.routes[e])for(n=this.routes[e].length;n>a;a++)if(r=this.routes[e][a],i.routablePath(t).match(r.path)){o=r;break}return o},runRoute:function(t,n,r,i){var o,a,s,u,l,p,f,d,h=this,g=this.lookupRoute(t,n);if(this.debug&&this.log("runRoute",[t,n].join(" ")),this.trigger("run-route",{verb:t,path:n,params:r}),"undefined"==typeof r&&(r={}),e.extend(r,this._parseQueryString(n)),g){this.trigger("route-found",{route:g}),null!==(f=g.path.exec(this.routablePath(n)))&&(f.shift(),e.each(f,function(e,t){g.param_names[e]?r[g.param_names[e]]=c(t):(r.splat||(r.splat=[]),r.splat.push(c(t)))})),o=new this.context_prototype(this,t,n,r,i),s=this.arounds.slice(0),u=this.befores.slice(0),p=[o],r.splat&&(p=p.concat(r.splat)),a=function(){for(var e,t,n;u.length>0;)if(l=u.shift(),h.contextMatchesOptions(o,l[0])&&(e=l[1].apply(o,[o]),e===!1))return!1;return h.last_route=g,o.trigger("event-context-before",{context:o}),"function"==typeof g.callback&&(g.callback=[g.callback]),g.callback&&g.callback.length&&(t=-1,n=function(){t++,g.callback[t]?e=g.callback[t].apply(o,p):h._onComplete&&h._onComplete(o)},p.push(n),n()),o.trigger("event-context-after",{context:o}),e},e.each(s.reverse(),function(e,t){var n=a;a=function(){return t.apply(o,[n])}});try{d=a()}catch(m){this.error(["500 Error",t,n].join(" "),m)}return d}return this.notFound(t,n)},contextMatchesOptions:function(t,n,r){var i=n;if(("string"==typeof i||l(i))&&(i={path:i}),"undefined"==typeof r&&(r=!0),e.isEmptyObject(i))return!0;if(u(i.path)){var o,a,s,c;for(o=[],a=0,c=i.path.length;c>a;a+=1)s=e.extend({},i,{path:i.path[a]}),o.push(this.contextMatchesOptions(t,s));var p=e.inArray(!0,o)>-1?!0:!1;return r?p:!p}if(i.only)return this.contextMatchesOptions(t,i.only,!0);if(i.except)return this.contextMatchesOptions(t,i.except,!1);var f=!0,d=!0;return i.path&&(l(i.path)||(i.path=new RegExp(i.path.toString()+"$")),f=i.path.test(t.path)),i.verb&&(d="string"==typeof i.verb?i.verb===t.verb:i.verb.indexOf(t.verb)>-1),r?d&&f:!(d&&f)},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(e){return this._location_proxy.setLocation(e)},swap:function(e,t){var n=this.$element().html(e);return s(t)&&t(e),n},templateCache:function(e,t){return"undefined"!=typeof t?h[e]=t:h[e]},clearTemplateCache:function(){return h={}},notFound:function(e,t){var n=this.error(["404 Not Found",e,t].join(" "));return"get"===e?n:!0},error:function(e,t){if(t||(t=new Error),t.message=[e,t.message].join(" "),this.trigger("error",{message:t.message,error:t}),this.raise_errors)throw t;this.log(t.message,t)},_checkLocation:function(){var e,t;return e=this.getLocation(),this.last_location&&"get"==this.last_location[0]&&this.last_location[1]==e||(this.last_location=["get",e],t=this.runRoute("get",e)),t},_getFormVerb:function(t){var n,r,i=e(t);return r=i.find('input[name="_method"]'),r.length>0&&(n=r.val()),n||(n=i[0].getAttribute("method")),n&&""!==n||(n="get"),e.trim(n.toString().toLowerCase())},_checkFormSubmission:function(t){var n,r,i,o,a;return this.trigger("check-form-submission",{form:t}),n=e(t),r=n.attr("action")||"",i=this._getFormVerb(n),this.debug&&this.log("_checkFormSubmission",n,r,i),"get"===i?(o=this._serializeFormParams(n),""!==o&&(r+="?"+o),this.setLocation(r),a=!1):(o=e.extend({},this._parseFormParams(n)),a=this.runRoute(i,r,o,t.get(0))),"undefined"==typeof a?!1:a},_serializeFormParams:function(e){var t,n="",r=e.serializeArray();if(r.length>0)for(n=this._encodeFormPair(r[0].name,r[0].value),t=1;t<r.length;t++)n=n+"&"+this._encodeFormPair(r[t].name,r[t].value);return n},_encodeFormPair:function(e,t){return p(e)+"="+p(t)},_parseFormParams:function(e){var t,n={},r=e.serializeArray();for(t=0;t<r.length;t++)n=this._parseParamPair(n,r[t].name,r[t].value);return n},_parseQueryString:function(e){var t,n,r,i,a={};if(t=e.match(o),t&&t[1])for(n=t[1].split("&"),i=0;i<n.length;i++)r=n[i].split("="),a=this._parseParamPair(a,c(r[0]),c(r[1]||""));return a},_parseParamPair:function(e,t,n){return"undefined"!=typeof e[t]?u(e[t])?e[t].push(n):e[t]=[e[t],n]:e[t]=n,e},_listen:function(e,t){return this.$element().bind([e,this.eventNamespace()].join("."),t)},_unlisten:function(e,t){return this.$element().unbind([e,this.eventNamespace()].join("."),t)}}),n.RenderContext=function(e){this.event_context=e,this.callbacks=[],this.previous_content=null,this.content=null,this.next_engine=!1,this.waiting=!1},n.RenderContext.prototype=e.extend({},n.Object.prototype,{then:function(e){if(!s(e)){if(!("string"==typeof e&&e in this.event_context))return this;var n=this.event_context[e];e=function(e){return n.apply(this.event_context,[e])}}var r=this;return this.waiting?this.callbacks.push(e):(this.wait(),t.setTimeout(function(){var t=e.apply(r,[r.content,r.previous_content]);t!==!1&&r.next(t)},0)),this},wait:function(){this.waiting=!0},next:function(e){this.waiting=!1,"undefined"!=typeof e&&(this.previous_content=this.content,this.content=e),this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(t,n,r){var i=this;return this.then(function(){var o,a,u;return s(n)?(r=n,n={}):n=e.extend({},n),r&&this.then(r),"string"==typeof t?(u=t.match(/\.json$/)||n.json,o=u?n.cache===!0:n.cache!==!1,i.next_engine=i.event_context.engineFor(t),delete n.cache,delete n.json,n.engine&&(i.next_engine=n.engine,delete n.engine),o&&(a=this.event_context.app.templateCache(t))?a:(this.wait(),e.ajax(e.extend({url:t,data:{},dataType:u?"json":"text",type:"get",success:function(e){o&&i.event_context.app.templateCache(t,e),i.next(e)}},n)),!1)):t.nodeType?t.innerHTML:t.selector?(i.next_engine=t.attr("data-engine"),n.clone===!1?t.remove()[0].innerHTML.toString():t[0].innerHTML.toString()):void 0})},loadPartials:function(e){var t;if(e){this.partials=this.partials||{};for(t in e)!function(t,n){t.load(e[n]).then(function(e){this.partials[n]=e})}(this,t)}return this},render:function(e,t,n,r){return s(e)&&!t?this.then(e):(s(t)?(r=n,n=t,t=null):n&&!s(n)&&(r=n,n=null),this.loadPartials(r).load(e).interpolate(t,e).then(n))},partial:function(e,t,n,r){return s(n)?this.render(e,t,r).swap(n):s(t)?this.render(e,{},n).swap(t):this.render(e,t,n).swap()},send:function(){var e=this,t=a(arguments),n=t.shift();return u(t[0])&&(t=t[0]),this.then(function(){return t.push(function(t){e.next(t)}),e.wait(),n.apply(n,t),!1})},collect:function(t,n,r){var i=this,o=function(){s(t)&&(n=t,t=this.content);var r=[],o=!1;return e.each(t,function(e,t){var a=n.apply(i,[e,t]);return a.jquery&&1==a.length&&(a=a[0],o=!0),r.push(a),a}),o?r:r.join("")};return r?o():this.then(o)},renderEach:function(t,n,r,i){return u(n)&&(i=r,r=n,n=null),this.load(t).then(function(o){var a=this;return r||(r=u(this.previous_content)?this.previous_content:[]),i?(e.each(r,function(e,r){var s={},u=this.next_engine||t;n?s[n]=r:s=r,i(r,a.event_context.interpolate(o,s,u))}),void 0):this.collect(r,function(e,r){var i={},a=this.next_engine||t;return n?i[n]=r:i=r,this.event_context.interpolate(o,i,a)},!0)})},interpolate:function(e,t,n){var r=this;return this.then(function(i,o){!e&&o&&(e=o),this.next_engine&&(t=this.next_engine,this.next_engine=!1);var a=r.event_context.interpolate(i,e,t,this.partials);return n?o+a:a})},swap:function(e){return this.then(function(t){return this.event_context.swap(t,e),t}).trigger("changed",{})},appendTo:function(t){return this.then(function(n){e(t).append(n)}).trigger("changed",{})},prependTo:function(t){return this.then(function(n){e(t).prepend(n)}).trigger("changed",{})},replace:function(t){return this.then(function(n){e(t).html(n)}).trigger("changed",{})},trigger:function(e,t){return this.then(function(n){return"undefined"==typeof t&&(t={content:n}),this.event_context.trigger(e,t),n})}}),n.EventContext=function(e,t,r,i,o){this.app=e,this.verb=t,this.path=r,this.params=new n.Object(i),this.target=o},n.EventContext.prototype=e.extend({},n.Object.prototype,{$element:function(){return this.app.$element(a(arguments).shift())},engineFor:function(e){var t,n=this;return s(e)?e:(e=(e||n.app.template_engine).toString(),(t=e.match(/\.([^\.\?\#]+)$/))&&(e=t[1]),e&&s(n[e])?n[e]:n.app.template_engine?this.engineFor(n.app.template_engine):function(e){return e})},interpolate:function(e,t,n,r){return this.engineFor(n).apply(this,[e,t,r])},render:function(e,t,r,i){return new n.RenderContext(this).render(e,t,r,i)},renderEach:function(e,t,r,i){return new n.RenderContext(this).renderEach(e,t,r,i)},load:function(e,t,r){return new n.RenderContext(this).load(e,t,r)},loadPartials:function(e){return new n.RenderContext(this).loadPartials(e)},partial:function(e,t,r,i){return new n.RenderContext(this).partial(e,t,r,i)},send:function(){var e=new n.RenderContext(this);return e.send.apply(e,arguments)},redirect:function(){var t,n=a(arguments),r=this.app.getLocation(),i=n.length;if(i>1){for(var o=0,s=[],u=[],l={},c=!1;i>o;o++)"string"==typeof n[o]?s.push(n[o]):(e.extend(l,n[o]),c=!0);if(t=s.join("/"),c){for(var p in l)u.push(this.app._encodeFormPair(p,l[p]));t+="?"+u.join("&")}}else t=n[0];this.trigger("redirect",{to:t}),this.app.last_location=[this.verb,this.path],this.app.setLocation(t),new RegExp(t).test(r)&&this.app.trigger("location-changed")},trigger:function(e,t){return"undefined"==typeof t&&(t={}),t.context||(t.context=this),this.app.trigger(e,t)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(e,t){return this.app.swap(e,t)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(t){return e.parseJSON(t)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}}),n})}(jQuery,window);